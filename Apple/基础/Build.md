# Build

<!-- create time: 2014-12-04 00:48:03  -->

在编译一个源文件时，编译器的处理过程分为几个阶段。要想查看编译 hello.m 源文件需要几个不同的阶段，我们可以让通过 clang 命令观察：

    % clang -ccc-print-phases hello.m

    0: input, "hello.m", objective-c
    1: preprocessor, {0}, objective-c-cpp-output
    2: compiler, {1}, assembler
    3: assembler, {2}, object
    4: linker, {3}, image
    5: bind-arch, "x86_64", {4}, image

##预处理

    --> clang -E Demo.c
    
    每当编源译文件的时候，编译器首先做的是一些预处理工作。比如预处理器会处理源文件中的宏定义，将代码中的宏用其对应定义的具体内容进行替换。

    注意
    建议不要在需要预处理的代码中加入内联代码逻辑。

##词法解析标记

    --> clang -Xclang -dump-tokens Demo.c
    预处理完成以后，每一个 .m 源文件里都有一堆的声明和定义。这些代码文本都会从 string 转化成特殊的标记流。

    每一个标记都包含了对应的源码内容和其在源码中的位置。注意这里的位置是宏展开之前的位置，这样一来，如果编译过程中遇到什么问题，clang 能够在源码中指出出错的具体位置。

##解析

    --> clang -Xclang -ast-dump -fsyntax-only hello.m
    
    之前生成的标记流将会被解析成一棵抽象语法树 (abstract syntax tree -- AST)。由于 Objective-C 是一门复杂的语言，因此解析的过程不简单。解析过后，源程序变成了一棵抽象语法树：一棵代表源程序的树。
    
##静态分析

    一旦编译器把源码生成了抽象语法树，编译器可以对这棵树做分析处理，以找出代码中的错误，比如类型检查：即检查程序中是否有类型错误。例如：如果代码中给某个对象发送了一个消息，编译器会检查这个对象是否实现了这个消息（函数、方法）。此外，clang 对整个程序还做了其它更高级的一些分析，以确保程序没有错误。
    
###类型检查

    动态的在运行时做检查，静态的在编译时做检查

##代码生成(失败)

    clang -O3 -emit-LLVM Demo.c -c -o Demo.bc  //生成
    clang 完成代码的标记，解析和分析后，接着就会生成 LLVM 代码。
    llvm-dis < hello.bc | less   //查看
##生成代码和优化
    将 AST 转换为更低级的中间码 (LLVM IR)
    对生成的中间码做优化
    生成特定目标代码
    输出汇编代码
##汇编器
    将汇编代码转换为目标对象文件。
##链接器
    将多个目标对象文件合并为一个可执行文件 (或者一个动态库)
